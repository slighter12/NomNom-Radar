# Common PostgreSQL 18 + PostGIS 3.6 configuration for both master and replica
x-postgres-common: &postgres-common
  image: postgis/postgis:18-3.6-alpine # PostgreSQL 18 with PostGIS 3.6 (Alpine)
  platform: linux/amd64 # Force AMD64 for ARM64 compatibility
  user: postgres
  restart: unless-stopped
  shm_size: 128mb
  environment: &postgres-env
    POSTGRES_USER: user
    POSTGRES_DB: auth_db
    POSTGRES_PASSWORD: password
    POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256 --data-checksums --encoding=UTF8 --locale=en_US.UTF-8"
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U user -d auth_db"]
    interval: 10s
    timeout: 5s
    retries: 5

services:
  # PostgreSQL Master Database
  postgres-master:
    <<: *postgres-common
    container_name: radar-postgres-master
    ports:
      - "5432:5432"
    command: |
      postgres
      -c wal_level=replica
      -c hot_standby=on
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby_feedback=on
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/backup_in_progress || exit 1; test ! -f /var/lib/postgresql/archive/%f || cp %p /var/lib/postgresql/archive/%f; rm %p'
      -c archive_timeout=60
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./database/postgres/master:/docker-entrypoint-initdb.d
    networks:
      - radar-network

  # PostgreSQL Read-Only Replica
  postgres-replica:
    <<: *postgres-common
    container_name: radar-postgres-replica
    ports:
      - "5433:5432"
    environment:
      <<: *postgres-env
      PGPASSWORD: password
    command: |
      bash -c "
      set -euo pipefail  # Better error handling

      echo 'Setting up PostgreSQL 18 PostGIS replica...'

      # Wait for master to be ready
      echo 'Waiting for master to be ready...'
      until pg_isready -h postgres-master -p 5432 -U user -d auth_db; do
        sleep 2
      done
      echo 'Master is ready!'

      # Prepare data directory for base backup
      REPLICA_DATA_DIR='/var/lib/postgresql/18/replica'
      rm -rf \"\$$REPLICA_DATA_DIR\" 2>/dev/null || true
      mkdir -p \"\$$(dirname \"\$$REPLICA_DATA_DIR\")\"

      # Perform base backup from master with replication slot
      echo 'Performing base backup from master...'
      pg_basebackup \\
        -h postgres-master \\
        -p 5432 \\
        -U user \\
        -D \"\$$REPLICA_DATA_DIR\" \\
        -R \\
        --slot=replica_slot \\
        --checkpoint=fast \\
        --verbose

      # Set correct permissions and start
      chmod 0700 \"\$$REPLICA_DATA_DIR\"
      echo 'Starting PostgreSQL replica in standby mode...'
      exec postgres -D \"\$$REPLICA_DATA_DIR\"
      "
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - radar-network

  # Geo Worker for async notification processing
  geoworker:
    build:
      context: .
      dockerfile: Dockerfile
      target: geoworker
    container_name: radar-geoworker
    ports:
      - "8081:8081"
    environment:
      - PUBSUB_PROVIDER=local
      - PMTILES_SOURCE=/app/data/map.pmtiles
      - PMTILES_ENABLED=true
      - PMTILES_ROADLAYER=transportation
      - PMTILES_ZOOMLEVEL=14
    volumes:
      - ./data/pmtiles:/app/data
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - radar-network
    profiles:
      - dev

volumes:
  postgres_master_data:
    driver: local
  postgres_replica_data:
    driver: local

networks:
  radar-network:
    driver: bridge
