x-postgres-common:
  &postgres-common
  image: postgres:18-alpine
  user: postgres
  restart: always
  shm_size: 128mb
  healthcheck:
    test: ['CMD-SHELL', 'pg_isready -U user -d auth_db']
    interval: 10s
    timeout: 5s
    retries: 5

services:
  postgres-master:
    <<: *postgres-common
    container_name: radar-postgres-master
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_DB: auth_db
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    command: |
      postgres 
      -c wal_level=replica 
      -c hot_standby=on 
      -c max_wal_senders=10 
      -c max_replication_slots=10 
      -c hot_standby_feedback=on
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/backup_in_progress || exit 1; test ! -f /var/lib/postgresql/archive/%f || cp %p /var/lib/postgresql/archive/%f; rm %p'
      -c archive_timeout=60
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./database/postgres/master:/docker-entrypoint-initdb.d
    networks:
      - radar-network

  postgres-replica:
    image: postgres:18-alpine
    container_name: radar-postgres-replica
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_DB: auth_db
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
      PGPASSWORD: password
      PGDATA: /var/lib/postgresql/data/18/main
    entrypoint: |
      bash -c "
      echo 'Setting up replica...'
      
      # Wait for master to be ready
      until pg_isready -h postgres-master -p 5432 -U user; do
        echo 'Waiting for master...'
        sleep 2
      done
      
      # Create directory structure
      mkdir -p /var/lib/postgresql/data/18/main
      
      # Clean data directory
      rm -rf /var/lib/postgresql/data/18/main/*
      
      # Perform base backup
      echo 'Performing base backup...'
      pg_basebackup -h postgres-master -p 5432 -U user -D /var/lib/postgresql/data/18/main -R --slot=replica_slot
      
      # Fix permissions
      chown -R postgres:postgres /var/lib/postgresql/data
      chmod 0700 /var/lib/postgresql/data/18/main
      
      echo 'Starting PostgreSQL replica...'
      exec docker-entrypoint.sh postgres
      "
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - radar-network

volumes:
  postgres_master_data:
    driver: local
  postgres_replica_data:
    driver: local

networks:
  radar-network:
    driver: bridge
