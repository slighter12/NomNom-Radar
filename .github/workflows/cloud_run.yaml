name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: true
        type: choice
        options:
          - radar
          - geoworker
      tag:
        description: 'Image tag (default: latest)'
        required: false
        default: 'latest'
      run_migration:
        description: 'Run database migration before deploy'
        required: false
        type: boolean
        default: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-east1
  REGISTRY: asia-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/radar

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Run Database Migration
        if: ${{ inputs.run_migration }}
        run: |
          # Install goose
          go install github.com/pressly/goose/v3/cmd/goose@latest

          # Fetch database credentials from Secret Manager
          PG_HOST=$(gcloud secrets versions access latest --secret="postgres-master-host" --project="${{ env.PROJECT_ID }}")
          PG_PORT=$(gcloud secrets versions access latest --secret="postgres-master-port" --project="${{ env.PROJECT_ID }}")
          PG_USER=$(gcloud secrets versions access latest --secret="postgres-master-username" --project="${{ env.PROJECT_ID }}")
          PG_PASS=$(gcloud secrets versions access latest --secret="postgres-master-password" --project="${{ env.PROJECT_ID }}")
          PG_DB=$(gcloud secrets versions access latest --secret="postgres-database" --project="${{ env.PROJECT_ID }}")

          # Build connection string and run migration
          PG_URI="postgres://${PG_USER}:${PG_PASS}@${PG_HOST}:${PG_PORT}/${PG_DB}?sslmode=require"
          $(go env GOPATH)/bin/goose postgres "${PG_URI}" -dir ./database/migration/postgres up

      - name: Set image name
        id: image
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "name=${{ env.REGISTRY }}/${OWNER}/${{ inputs.target }}:${{ inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Prepare service YAML
        run: |
          # Build final YAML using kubectl's built-in kustomize
          kubectl kustomize deploy/cloud-run/overlays/${{ inputs.target }} > /tmp/service.yaml
          # Replace image placeholder
          sed -i "s|IMAGE_PLACEHOLDER|${{ steps.image.outputs.name }}|g" /tmp/service.yaml
          # Replace service account placeholder
          sed -i "s|SERVICE_ACCOUNT_PLACEHOLDER|${{ secrets.GCP_SA_EMAIL }}|g" /tmp/service.yaml

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run services replace /tmp/service.yaml \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }}

          # radar should allow unauthenticated access
          if [ "${{ inputs.target }}" = "radar" ]; then
            gcloud run services add-iam-policy-binding ${{ inputs.target }} \
              --project=${{ env.PROJECT_ID }} \
              --region=${{ env.REGION }} \
              --member="allUsers" \
              --role="roles/run.invoker"
          fi

      - name: Show Output
        run: |
          gcloud run services describe ${{ inputs.target }} \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)'
