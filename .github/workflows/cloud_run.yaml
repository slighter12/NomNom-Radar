name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: true
        type: choice
        options:
          - radar
          - geoworker
      tag:
        description: 'Image tag (default: latest)'
        required: false
        default: 'latest'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-east1
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set image name
        id: image
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "name=${{ env.REGISTRY }}/${OWNER}/${{ inputs.target }}:${{ inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: ${{ inputs.target }}
          region: ${{ env.REGION }}
          image: ${{ steps.image.outputs.name }}
          env_vars: |
            PMTILES_SOURCE=${{ secrets.PMTILES_SOURCE }}
            POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
            POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DATABASE=${{ secrets.POSTGRES_DATABASE }}
            SECRETKEY_ACCESS=${{ secrets.SECRETKEY_ACCESS }}
            SECRETKEY_REFRESH=${{ secrets.SECRETKEY_REFRESH }}
            FIREBASE_PROJECTID=${{ secrets.FIREBASE_PROJECTID }}
            PUBSUB_PROVIDER=${{ secrets.PUBSUB_PROVIDER }}
            PUBSUB_PROJECTID=${{ secrets.PUBSUB_PROJECTID }}
            PUBSUB_TOPICID=${{ secrets.PUBSUB_TOPICID }}
          # radar: public API, geoworker: Pub/Sub only (requires IAM auth)
          flags: ${{ inputs.target == 'radar' && '--allow-unauthenticated' || '' }}

      - name: Show Output
        run: echo ${{ steps.deploy.outputs.url }}
