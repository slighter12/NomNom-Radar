name: GHCR image cleanup

on:
  schedule:
    - cron: '0 3 * * 0' # Runs weekly on Sunday at UTC 03:00
  workflow_dispatch:

permissions:
  packages: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [radar, geoworker]
    steps:
      - name: Set variables
        run: |
          echo "OWNER=$(echo ${GITHUB_REPOSITORY_OWNER} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "PACKAGE_NAME=${{ matrix.package }}" >> $GITHUB_ENV

      - name: Cleanup GHCR images
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          OWNER="${OWNER}"
          PACKAGE_NAME="${PACKAGE_NAME}"
          RETAIN_COUNT=10      # Keep the latest N images
          MAX_DAYS=30          # Delete images older than N days

          # Fetch all package versions from GHCR
          echo "Fetching package versions from GHCR..."
          VERSIONS_JSON=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100")

          # Get current timestamp in seconds
          NOW_TS=$(date +%s)

          # Use jq to flatten tags into: version_id, tag_name, created_at
          # Sort by created_at descending (newest first)
          TAGS=$(echo "$VERSIONS_JSON" | jq -r '
            sort_by(.created_at) | reverse |
            .[] as $v |
            $v.metadata.container.tags[]? as $tag |
            [$v.id, $tag, $v.created_at] | @tsv
          ')

          if [ -z "$TAGS" ]; then
            echo "No tags found, exit."
            exit 0
          fi

          # Process all tags
          INDEX=0
          echo "$TAGS" | while IFS=$'\t' read -r VID TAG CREATED_AT; do
            INDEX=$((INDEX + 1))
            CREATED_TS=$(date -d "$CREATED_AT" +%s)
            AGE_DAYS=$(( (NOW_TS - CREATED_TS) / 86400 ))

            DELETE=false

            # Rule 1: Always preserve semantic version tags (e.g., v1.0.0, v2.3.1)
            if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "Preserve : tag=$TAG (semantic version) id=$VID age=${AGE_DAYS}d"
              continue
            fi

            # Rule 2: Keep the latest RETAIN_COUNT images
            if [ "$INDEX" -le "$RETAIN_COUNT" ]; then
              echo "Keep     : tag=$TAG id=$VID age=${AGE_DAYS}d index=$INDEX (within retain count)"
              continue
            fi

            # Rule 3: Delete images older than MAX_DAYS
            if [ "$AGE_DAYS" -gt "$MAX_DAYS" ]; then
              DELETE=true
            fi

            if [ "$DELETE" = true ]; then
              echo "Delete   : tag=$TAG id=$VID age=${AGE_DAYS}d index=$INDEX"

              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${VID}" || true
            else
              echo "Keep     : tag=$TAG id=$VID age=${AGE_DAYS}d index=$INDEX"
            fi
          done
