apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: radar
  annotations:
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "10"
    spec:
      containerConcurrency: 80
      timeoutSeconds: 300
      containers:
        - image: IMAGE_PLACEHOLDER
          ports:
            - containerPort: 8080
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          env:
            # ========== Postgres Configuration ==========
            # Master connection
            - name: POSTGRES_MASTER_HOST
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: postgres-master-host
            - name: POSTGRES_MASTER_PORT
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: postgres-master-port
            - name: POSTGRES_MASTER_USERNAME
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: postgres-master-username
            - name: POSTGRES_MASTER_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: postgres-master-password
            # Database settings
            - name: POSTGRES_DATABASE
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: postgres-database
            # SSL settings (Supabase requires "require" or "verify-full")
            - name: POSTGRES_SSLMODE
              value: "require"

            # ========== Auth Configuration ==========
            - name: SECRETKEY_ACCESS
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: secretkey-access
            - name: SECRETKEY_REFRESH
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: secretkey-refresh

            # ========== Firebase Configuration ==========
            - name: FIREBASE_PROJECTID
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: firebase-projectid

            # ========== PubSub Configuration ==========
            - name: PUBSUB_PROVIDER
              value: "google"
            - name: PUBSUB_PROJECTID
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: pubsub-projectid
            - name: PUBSUB_TOPICID
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: pubsub-topicid

            # ========== PMTiles Configuration ==========
            - name: PMTILES_SOURCE
              valueFrom:
                secretKeyRef:
                  key: latest
                  name: pmtiles-source
            - name: PMTILES_ENABLED
              value: "true"
